sap.ui.define(["./BaseController","../model/formatter","sap/ui/model/json/JSONModel","sap/base/strings/capitalize","sap/m/library"],function(t,e,a,r,n){"use strict";var i=n.URLHelper;return t.extend("gruene.ueberherrn.controller.StandByDuty",{formatter:e,URLHelper:i,_aDutyTypes:["doctor","pediatrist","dentist","oculist","otorhinolaryngologist","pharmacy","vet"],onInit:function(){this.initBase();this._initModel();this._setDutyData();this.byId("scrollContainer").scrollTo(0,0,0);this._sIntervalID=window.setInterval(()=>{this._setDutyData()},60*1e3)},onExit:function(){window.clearInterval(this._sIntervalID)},onMapButtonPress:function(t){var e=t.getSource().getBindingContext("standByDuty");var a=e.getProperty("name");var r=e.getProperty("longitude");var n=e.getProperty("latitude");if(this.getModel("device").getProperty("/os/ios")){var s="http://maps.apple.com/?ll="+n+","+r+"&q="+a}else{s="geo:0,0?q="+n+","+r+"("+a+")"}i.redirect(s)},_initModel:function(){var t=this.getResourceBundle();var e=[];for(var n=0,i=this._aDutyTypes.length;n<i;n++){e.push({dutyType:this._aDutyTypes[n],dutyTypeText:t.getText("dutyType"+r(this._aDutyTypes[n])),dutyTime:"",name:"",phone:"",phone2:"",longitude:"",latitude:""})}this.setModel(new a({dutyTimeFrame:"",dutyItems:e}),"standByDuty")},_setDutyData:function(){this._setDutyTimeFrame();this._setDutyItems()},_setDutyTimeFrame:function(){var t=this._getStartEndDate();var a=e.dateWithoutYear(t.start)+" ‒ "+e.dateWithoutYear(t.end);this.getModel("standByDuty").setProperty("/dutyTimeFrame",a)},_setDutyItems:function(){var t=this.getModel("standByDuty");var e=t.getProperty("/dutyItems");var a=new Date;var r=a.getDay();var n=this._getDiffDaysToStart(r);this.getOwnerComponent().getStandByDutyData().then(a=>{var i=a.dutyContact;var s=a.dutyCycle;var o=this._getActiveDutyCycle(s);for(var u=0,y=e.length;u<y;u++){var l=o[e[u].dutyType];if(!l){e[u].dutyTime="";e[u].name="";e[u].phone="";e[u].phone2="";e[u].longitude="";e[u].latitude="";continue}var d="";var g=[];for(var h in l){if(l[h].indexOf(r)>-1){d=h;g=l[h];break}var D=7;l[h].forEach(t=>{var e=this._getDiffDaysToStart(t);if(e-n>=0&&e-n<D){d=h;g=l[h];D=e-n}})}if(!d){d=h;g=l[h]}e[u].dutyTime=this._getDutyTime(g);if(i[d]){e[u].name=i[d].name;e[u].phone=i[d].phone;e[u].phone2=i[d].phone2;e[u].longitude=i[d].longitude;e[u].latitude=i[d].latitude}else{e[u].name=d}}t.setProperty("/dutyItems",e)})},_getStartEndDate:function(){var t=new Date;var e=this._getDiffDaysToStart(t.getDay());var a=new Date(t.getTime()-e*24*60*60*1e3);var r=new Date(a.getFullYear(),a.getMonth(),a.getDate());var n=new Date(r.getTime()+6*24*60*60*1e3);return{start:r,end:n}},_getDiffDaysToStart:function(t){return t>=5?t-5:t-5+7},_getActiveDutyCycle:function(t){var e={};var a=this._getStartEndDate();for(var r=0,n=t.length;r<n;r++){var i=this._getDateByDateString(t[r].validFrom);if(i.getTime()===a.start.getTime()){e=t[r];break}}return e},_getDateByDateString:function(t){return new Date(Number(t.substr(0,4)),Number(t.substr(5,2))-1,Number(t.substr(8,2)))},_getDutyTime:function(t){let a="";if(t.length===1){let r=this._getDateByWeekday(t[0]);a=e.getWeekdayLong(r)+" "+e.dateFull(r)}else if(t.length===2){let r=this._getDateByWeekday(t[0]);let n=this._getDateByWeekday(t[1]);a=e.getWeekdayShort(r)+" "+e.dateFull(r)+" / "+e.getWeekdayShort(n)+" "+e.dateFull(n)}else if(t.length>2){let r=this._getDateByWeekday(t[0]);let n=this._getDateByWeekday(t[t.length-1]);a=e.getWeekdayShort(r)+" "+e.dateFull(r)+" ‒ "+e.getWeekdayShort(n)+" "+e.dateFull(n)}else{let t=new Date;a=e.getWeekdayLong(t)+" "+e.dateFull(t)}return a},_getDateByWeekday:function(t){var e=this._getStartEndDate();var a=this._getDiffDaysToStart(t);return new Date(e.start.getTime()+a*24*60*60*1e3)}})});